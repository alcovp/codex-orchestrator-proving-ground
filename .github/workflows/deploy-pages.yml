name: Deploy static snapshots to GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout existing Pages branch (for history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: .gh-pages
          fetch-depth: 1
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare Pages content
        env:
          RUN_NUMBER: ${{ github.run_number }}
          SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
          REPO: ${{ github.repository }}
          PAGES_DIR: .pages
        run: |
          set -euo pipefail

          mkdir -p "$PAGES_DIR"

          if [ -f .gh-pages/runs.json ]; then
            cp .gh-pages/runs.json "$PAGES_DIR/runs.json"
          else
            echo '{"runs":[]}' > "$PAGES_DIR/runs.json"
          fi

          mkdir -p "$PAGES_DIR/runs/$RUN_NUMBER"
          cp -r dist/* "$PAGES_DIR/runs/$RUN_NUMBER/"
          cat > "$PAGES_DIR/runs/$RUN_NUMBER/meta.json" <<EOF
          {
            "run": $RUN_NUMBER,
            "commit": "$SHA",
            "ref": "$REF",
            "repository": "$REPO",
            "createdAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

          rm -rf "$PAGES_DIR/latest"
          mkdir -p "$PAGES_DIR/latest"
          cp -r dist/* "$PAGES_DIR/latest/"

          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const pagesDir = process.env.PAGES_DIR || '.pages';
          const runNumber = Number(process.env.RUN_NUMBER);
          const sha = process.env.SHA || '';
          const ref = process.env.REF || '';
          const repo = process.env.REPO || '';

          const runsFile = path.join(pagesDir, 'runs.json');
          let data = { runs: [] };
          try {
            data = JSON.parse(fs.readFileSync(runsFile, 'utf8'));
          } catch (err) {
            data = { runs: [] };
          }

          if (!Array.isArray(data.runs)) {
            data.runs = [];
          }

          const exists = data.runs.some((entry) => Number(entry.run) === runNumber);
          if (!exists) {
            data.runs.push({
              run: runNumber,
              commit: sha,
              ref,
              repository: repo,
              createdAt: new Date().toISOString(),
            });
          }

          data.runs.sort((a, b) => Number(b.run) - Number(a.run));
          fs.writeFileSync(runsFile, JSON.stringify(data, null, 2));

          const listItems = data.runs
            .map((entry) => {
              const shortSha = (entry.commit || '').slice(0, 7);
              const created = entry.createdAt || '';
              return `<li><a href="./runs/${entry.run}/" target="_blank" rel="noopener">Run #${entry.run}</a> â€” ${entry.ref || ''} @ ${shortSha}${created ? ` (${created})` : ''}</li>`;
            })
            .join('');

          const indexHtml = `<!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Deploy snapshots</title>
              <style>
                :root { color-scheme: light dark; }
                body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 0 auto; max-width: 960px; padding: 24px; line-height: 1.5; }
                h1 { margin-top: 0; }
                nav { margin: 16px 0; }
                ul { padding-left: 20px; }
                li { margin: 4px 0; }
                code { background: rgba(128,128,128,0.15); padding: 2px 4px; border-radius: 4px; }
              </style>
            </head>
            <body>
              <main>
                <h1>GitHub Pages snapshots</h1>
                <nav>
                  <a href="./latest/" target="_blank" rel="noopener">Open latest build</a>
                </nav>
                <section>
                  <p>Each build is kept under <code>runs/&lt;run-number&gt;/</code>. Use the GitHub Actions run number to open a specific snapshot.</p>
                  <ul>${listItems}</ul>
                </section>
              </main>
            </body>
          </html>`;

          fs.writeFileSync(path.join(pagesDir, 'index.html'), indexHtml);
          NODE

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .pages
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Deploy run ${{ github.run_number }}: ${{ github.ref }} @ ${{ github.sha }}"
